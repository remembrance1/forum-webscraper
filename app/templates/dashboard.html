{% extends 'sb_base.html' %}

{% block page %}

<div class="d-sm-flex align-items-center justify-content-between mb-4">
  <h1 class="h3 mb-0 text-gray-800">Dashboard</h1>
</div>

<!-- Function Tabs -->
<ul class="nav nav-tabs mb-3" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="scraper-tab" data-bs-toggle="tab" data-bs-target="#scraper-pane" type="button" role="tab" aria-controls="scraper-pane" aria-selected="true">
      üîé Scraper
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="crawler-tab" data-bs-toggle="tab" data-bs-target="#crawler-pane" type="button" role="tab" aria-controls="crawler-pane" aria-selected="false">
      üï∏Ô∏è Crawler
    </button>
  </li>
</ul>

<div class="tab-content">

  <!-- =========================
       SCRAPER DASHBOARD
       ========================= -->
  <div class="tab-pane fade show active" id="scraper-pane" role="tabpanel" aria-labelledby="scraper-tab">

    <div class="row g-3">
      <!-- Stat cards -->
      <div class="col-12 col-sm-6 col-xl-3">
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <div class="text-muted">Total Scans</div>
                <div class="h3 mb-0">{{ stats_scraper.total_scans or 0 }}</div>
              </div>
              <div class="text-primary fs-3">üîé</div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-sm-6 col-xl-3">
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <div class="text-muted">Matches Found</div>
                <div class="h3 mb-0">{{ stats_scraper.total_matches or 0 }}</div>
              </div>
              <div class="text-primary fs-3">‚úÖ</div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-sm-6 col-xl-3">
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <div class="text-muted">Last Scan</div>
                <div class="h3 mb-0">{{ stats_scraper.last_scan or '‚Äî' }}</div>
              </div>
              <div class="text-primary fs-3">‚è±Ô∏è</div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-sm-6 col-xl-3">
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <div class="text-muted">Account</div>
                <div class="h3 mb-0">{{ current_user.email }}</div>
              </div>
              <div class="text-primary fs-3">üë§</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick actions -->
      <div class="col-12">
        <div class="card">
          <div class="card-header"><h5 class="card-title mb-0">Quick Actions</h5></div>
          <div class="card-body d-flex flex-wrap gap-2">
            <a class="btn btn-outline-primary" href="{{ url_for('main.scraper') }}">Open Scraper</a>
            <a class="btn btn-outline-secondary" href="{{ url_for('main.history') }}?tab=scraper">View Scraper History</a>
          </div>
        </div>
      </div>

      <!-- Recent scans -->
      <div class="col-12">
        <div class="card">
          <div class="card-header"><h5 class="card-title mb-0">Recent Scans</h5></div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead>
                  <tr>
                    <th style="width: 30%;">Source URL</th>
                    <th>Keyword</th>
                    <th>Sub-keyword</th>
                    <th>Matches</th>
                    <th>Logic</th>
                    <th>Created Time</th>
                  </tr>
                </thead>
                <tbody>
                  {% if recent_scans %}
                    {% for s in recent_scans %}
                    <tr>
                      <td class="text-truncate" style="max-width: 420px;">{{ s.source_url }}</td>
                      <td>{{ s.keyword or '‚Äî' }}</td>
                      <td>{{ s.subkeyword or '‚Äî' }}</td>
                      <td>{{ s.num_matches }}</td>
                      <td>{{ s.logic or '‚Äî' }}</td>
                      <td>{{ s.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                    </tr>
                    {% endfor %}
                  {% else %}
                    <tr><td colspan="6" class="text-muted text-center py-4">No scans yet.</td></tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- =========================
       CRAWLER DASHBOARD
       ========================= -->
  <div class="tab-pane fade" id="crawler-pane" role="tabpanel" aria-labelledby="crawler-tab">

    <div class="row g-3">
      <!-- Stat cards -->
      <div class="col-12 col-sm-6 col-xl-3">
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <div class="text-muted">Total Crawls</div>
                <div class="h3 mb-0">{{ stats_crawler.total_crawls or 0 }}</div>
              </div>
              <div class="text-primary fs-3">üï∏Ô∏è</div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-sm-6 col-xl-3">
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <div class="text-muted">Pages Visited</div>
                <div class="h3 mb-0">{{ stats_crawler.pages_visited or 0 }}</div>
              </div>
              <div class="text-primary fs-3">üìÑ</div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-sm-6 col-xl-3">
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <div class="text-muted">Last Crawl</div>
                <div class="h3 mb-0">{{ stats_crawler.last_crawl or '‚Äî' }}</div>
              </div>
              <div class="text-primary fs-3">‚è±Ô∏è</div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-sm-6 col-xl-3">
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <div class="text-muted">Account</div>
                <div class="h3 mb-0">{{ current_user.email }}</div>
              </div>
              <div class="text-primary fs-3">üë§</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick actions -->
      <div class="col-12">
        <div class="card">
          <div class="card-header"><h5 class="card-title mb-0">Quick Actions</h5></div>
          <div class="card-body d-flex flex-wrap gap-2">
            <a class="btn btn-outline-primary" href="{{ url_for('crawler.crawler_form') }}">Open Crawler</a>
            <a class="btn btn-outline-secondary" href="{{ url_for('main.history') }}?tab=crawler">View Crawler History</a>
          </div>
        </div>
      </div>

      <!-- Recent crawls -->
      <div class="col-12">
        <div class="card">
          <div class="card-header"><h5 class="card-title mb-0">Recent Crawls</h5></div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead>
                  <tr>
                    <th style="width: 30%;">Start URL</th>
                    <th>Keyword</th>
                    <th>Sub-keyword</th>
                    <th>Pages Crawled</th>
                    <th>Matches</th>
                    <th>Created Time</th>
                  </tr>
                </thead>
                <tbody>
                  {% if recent_crawls %}
                    {% for c in recent_crawls %}
                    <tr>
                      <td class="text-truncate" style="max-width: 420px;">{{ c.start_url }}</td>
                      <td>{{ c.keyword or '‚Äî' }}</td>
                      <td>{{ c.sub_keyword or '‚Äî' }}</td>
                      <td>{{ c.pages_crawled or 0 }}</td>
                      <td>{{ c.num_matches or 0 }}</td>
                      <td>{{ c.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                    </tr>
                    {% endfor %}
                  {% else %}
                    <tr><td colspan="6" class="text-muted text-center py-4">No crawls yet.</td></tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

</div>

{% endblock %}
