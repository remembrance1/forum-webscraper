{% extends 'base.html' %}
{% block content %}
<section>
  {% if status != 'done' %}
  <div id="progress-wrap" class="secondary" style="padding:12px; margin:12px 0;">
    <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
      <strong>Scanning…</strong>
      <span id="progress-label">0%</span>
    </div>
    <div style="height:10px; background:#eee; border-radius:6px; overflow:hidden;">
      <div id="progress-bar" style="height:100%; width:0%; background:#4a90e2;"></div>
    </div>
    <div class="muted" id="progress-msg" style="margin-top:6px;"></div>
  </div>
  <script>
  (function(){
    const bar = document.getElementById('progress-bar');
    const label = document.getElementById('progress-label');
    const msg = document.getElementById('progress-msg');
    const progressUrl = "{{ url_for('main.progress', run_id=run_id) }}";

    function fmtSec(s){
      if (s == null) return "estimating…";
      s = Math.max(0, parseInt(s, 10));
      const m = Math.floor(s / 60);
      const r = s % 60;
      return (m ? (m + "m ") : "") + r + "s";
    }

    async function poll(){
      try {
        const r = await fetch(progressUrl, { cache: 'no-store' });
        if (!r.ok) throw new Error('progress fetch failed');
        const p = await r.json();

        if (p.total > 0) {
          const pct = Math.min(100, Math.round((p.current / p.total) * 100));
          bar.style.width = pct + '%';
          label.textContent = pct + '%';
        }

        const parts = [];
        if (typeof p.pages_scanned === 'number' && typeof p.total === 'number') {
          parts.push(`Pages: ${p.pages_scanned}/${p.total}`);
        }
        if (typeof p.matches === 'number') {
          parts.push(`Matches: ${p.matches}`);
        }
        if ("eta_seconds" in p) {
          parts.push(`ETA: ${fmtSec(p.eta_seconds)}`);
        }
        msg.textContent = parts.join(' · ') || (p.message || '');

        if (p.status === 'done') {
          location.reload();
          return;
        } else if (p.status === 'error') {
          msg.textContent = 'Scan failed: ' + (p.message || 'Unknown error');
          label.textContent = 'Error';
          return;
        }
      } catch(e){
        msg.textContent = 'Waiting for progress…';
      }
      setTimeout(poll, 800);
    }
    poll();
  })();
  </script>

  {% else %}

  <p class="muted">Source: <a href="{{ source_url }}" target="_blank" rel="noopener noreferrer" class="url">{{ source_url }}</a></p>
  <p><strong>Keyword:</strong> <span class="mono">{{ keyword }}</span></p>
  <p><strong>Sub-keyword:</strong> <span class="mono">{{ sub_keyword if sub_keyword else 'NA' }}</span></p>
  <p><strong>Total results:</strong> <span class="mono">{{ total }}</span></p>

  <details>
    <summary>Scan options</summary>
    <ul>
      {% if match_text is not none %}<li>Match in link text: <strong>{{ 'Yes' if match_text else 'No' }}</strong></li>{% endif %}
      {% if match_url  is not none %}<li>Match in URL: <strong>{{ 'Yes' if match_url else 'No' }}</strong></li>{% endif %}
      {% if same_domain is not none %}<li>Same domain only: <strong>{{ 'Yes' if same_domain else 'No' }}</strong></li>{% endif %}
      <li>Total matches: <strong>{{ total }}</strong></li>
      <li>Page: <strong>{{ page }}</strong> / <strong>{{ total_pages }}</strong></li>
    </ul>
  </details>

  <div style="margin: 12px 0; display: flex; gap: 8px; flex-wrap: wrap; align-items:center;">
    <a href="{{ url_for('main.scraper') }}" role="button" class="secondary">New Scan</a>
    <div role="group" style="display:inline-flex; gap:8px;">
      <a href="{{ url_for('main.export_html') }}" role="button" class="contrast">Export HTML</a>
      <a href="{{ url_for('main.export_csv') }}" role="button" class="secondary">Export CSV</a>
      <a href="{{ url_for('main.export_xlsx') }}" role="button">Export Excel</a>
    </div>
  </div>

  {% if matches %}
    {# per_page is passed from the view; fall back to this page’s length if missing #}
    {% set per_page = per_page|default(matches|length, true) %}
    {% set start_index = ((page - 1) * per_page) + 1 %}

    <ol class="results" start="{{ start_index }}" style="padding-left: 1.25rem; margin: 0;">
      {% for r in matches %}

        {# Normalise: accept dicts, tuples, or raw strings #}
        {% if r is mapping %}
          {% set href    = r.get('url') %}
          {% set title   = r.get('title') %}
          {% set snippet = r.get('snippet') %}
        {% elif r is sequence %}
          {% set href    = (r[1] if r|length > 1 else r[0]) %}
          {% set title   = (r[0] if r|length > 1 else None) %}
          {% set snippet = (r[2] if r|length > 2 else None) %}
        {% else %}
          {% set href    = r %}
          {% set title   = None %}
          {% set snippet = None %}
        {% endif %}

        {# Fallback: if the title looks generic, derive one from the URL slug #}
        {% set display = title or '' %}
        {% if ('Breaking News and Analysis' in (display or '')) or (display|length < 6) %}
          {% set slug = href.split('?')[0].rstrip('/').split('/')[-1] %}
          {% set display = slug|replace('-', ' ')|replace('_', ' ')|title %}
        {% endif %}

        <li style="margin: 0 0 .9rem 0;">
          <a href="{{ href }}" target="_blank" rel="noopener">{{ display or href }}</a>
          <div class="muted mono" style="font-size:.9em; line-height:1.2; word-break: break-all;">{{ href }}</div>
          {% if snippet %}
            <div class="muted" style="font-size:.95em; margin-top:2px;">{{ snippet }}</div>
          {% endif %}
        </li>
      {% endfor %}
    </ol>
  {% else %}
    <article class="secondary">No matches found. Try a broader keyword or different page.</article>
  {% endif %}


  <!-- Pager -->
  <nav aria-label="Results pages" style="margin-top: 14px; display: flex; gap: 6px; flex-wrap: wrap;">
    {% set first_disabled = (page == 1) %}
    {% set last_disabled  = (page == total_pages) %}

    <a role="button" class="secondary" href="{{ url_for('main.results', page=1) }}"
       {% if first_disabled %}aria-disabled="true" tabindex="-1" style="pointer-events:none; opacity:.5;"{% endif %}>« First</a>
    <a role="button" class="secondary" href="{{ url_for('main.results', page=page-1) }}"
       {% if first_disabled %}aria-disabled="true" tabindex="-1" style="pointer-events:none; opacity:.5;"{% endif %}>‹ Prev</a>

    {% set start_p = 1 if (page - 2) < 1 else (page - 2) %}
    {% set end_p = total_pages if (page + 2) > total_pages else (page + 2) %}
    {% for p in range(start_p, end_p + 1) %}
      {% if p == page %}
        <span role="button" class="secondary" aria-current="page" style="font-weight:700;">{{ p }}</span>
      {% else %}
        <a role="button" class="secondary" href="{{ url_for('main.results', page=p) }}">{{ p }}</a>
      {% endif %}
    {% endfor %}

    <a role="button" class="secondary" href="{{ url_for('main.results', page=page+1) }}"
       {% if last_disabled %}aria-disabled="true" tabindex="-1" style="pointer-events:none; opacity:.5;"{% endif %}>Next ›</a>
    <a role="button" class="secondary" href="{{ url_for('main.results', page=total_pages) }}"
       {% if last_disabled %}aria-disabled="true" tabindex="-1" style="pointer-events:none; opacity:.5;"{% endif %}>Last »</a>
  </nav>

  {% endif %}
</section>
{% endblock %}
